<div class="analytics-container" [@fadeInUp]>
  <div class="analytics-header" [@slideIn]>
    <div class="header-content">
      <h1 class="page-title">Thống kê doanh thu</h1>
      <p class="page-subtitle">Theo dõi và phân tích doanh thu từ các sự kiện</p>
    </div>

    <div class="header-actions">
      <div class="filter-group">
        <mat-select
          class="filter-select"
          [value]="selectedYear()"
          (selectionChange)="onYearChange($event.value)">
          <mat-option *ngFor="let year of filterOptions.years" [value]="year">
            {{ year }}
          </mat-option>
        </mat-select>

        <mat-select
          class="filter-select"
          [value]="selectedEventType()"
          (selectionChange)="onEventTypeChange($event.value)">
          <mat-option *ngFor="let type of filterOptions.eventTypes" [value]="type.value">
            {{ type.label }}
          </mat-option>
        </mat-select>
      </div>

      <!-- <button mat-raised-button class="export-btn" (click)="onExportReport()">
        <mat-icon>download</mat-icon>
        Xuất báo cáo
      </button> -->
    </div>
  </div>

  <div *ngIf="loading()" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Đang tải dữ liệu thống kê...</p>
  </div>

  <div *ngIf="!loading()">
    <div class="metrics-grid" [@staggerCards]>
      <div
        *ngFor="let metric of getMetricsData()"
        class="metric-card"
        [class]="'metric-' + metric.color">
        <div class="metric-header">
          <div class="metric-icon" [class]="metric.color">
            <mat-icon>{{ metric.icon }}</mat-icon>
          </div>
          <div class="metric-trend">
            <!-- <span [class]="getTrendClass(metric.trend)">
              {{ metric.trend }}
            </span> -->
          </div>
        </div>
        <div class="metric-content">
          <h3 class="metric-value">{{ metric.value }}</h3>
          <p class="metric-title">{{ metric.title }}</p>
          <span class="metric-subtitle">{{ metric.subtitle }}</span>
        </div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-card large">
        <div class="chart-header">
          <h3>Doanh thu theo thời gian</h3>
          <div class="chart-actions">
            <button class="chart-btn active">Doanh thu</button>
            <button class="chart-btn">Đơn hàng</button>
          </div>
        </div>
        <div class="chart-container">
          <p-chart
            type="line"
            [data]="revenueChartData"
            [options]="revenueChartOptions"
            height="350px">
          </p-chart>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>Doanh thu theo loại sự kiện</h3>
        </div>
        <div class="chart-container">
          <p-chart
            type="pie"
            [data]="pieChartData"
            [options]="pieChartOptions"
            height="350px">
          </p-chart>
        </div>
        <div class="pie-legend">
          <div
            *ngFor="let item of eventTypeRevenue()"
            class="legend-item">
            <div class="legend-color" [style.backgroundColor]="item.color"></div>
            <span class="legend-text">{{ item.name }}</span>
            <span class="legend-value">{{ formatCurrency(item.revenue) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <h3>Top sự kiện có doanh thu cao nhất</h3>
        <button class="view-all-btn">Xem tất cả</button>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="topEvents()" class="events-table">
          <ng-container matColumnDef="event">
            <th mat-header-cell *matHeaderCellDef>Tên sự kiện</th>
            <td mat-cell *matCellDef="let event; let i = index">
              <div class="event-info">
                <div class="event-rank">#{{ i + 1 }}</div>
                <div class="event-details">
                  <span class="event-name">{{ event.name }}</span>
                  <span class="event-status" [class]="getStatusClass(event.status)">
                    {{ event.status === 'active' ? 'Đang diễn ra' :
                       event.status === 'completed' ? 'Đã kết thúc' : 'Sắp diễn ra' }}
                  </span>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="revenue">
            <th mat-header-cell *matHeaderCellDef>Doanh thu</th>
            <td mat-cell *matCellDef="let event" class="revenue-cell">
              {{ formatCurrency(event.revenue) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="tickets">
            <th mat-header-cell *matHeaderCellDef>Vé đã bán</th>
            <td mat-cell *matCellDef="let event">
              {{ formatNumber(event.tickets) }} vé
            </td>
          </ng-container>

          <ng-container matColumnDef="growth">
            <th mat-header-cell *matHeaderCellDef>Tăng trưởng</th>
            <td mat-cell *matCellDef="let event">
              <span class="growth" [class]="getTrendClass(event.growth)">
                {{ event.growth }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let event">
              <button
                class="action-btn"
                (click)="onViewEventDetails(event.name)"
                matTooltip="Xem chi tiết">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['event', 'revenue', 'tickets', 'growth', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['event', 'revenue', 'tickets', 'growth', 'actions']"></tr>
        </table>
      </div>
    </div>
  </div>
</div>
